<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProPaint Web - Studio Final</title>
    <style>
        /* --- CSS VARIABLES & THEME --- */
        :root {
            --bg-dark: #1e1e1e;
            --bg-panel: #252526;
            --bg-header: #333333;
            --text-main: #cccccc;
            --text-muted: #858585;
            --accent: #007fd4;
            --accent-hover: #0060a0;
            --border: #3e3e42;
            --tool-size: 40px;
            --header-height: 35px;
            --sidebar-width: 50px;
            --panel-width: 260px;
        }

        body.light-theme {
            --bg-dark: #f3f3f3;
            --bg-panel: #ffffff;
            --bg-header: #e0e0e0;
            --text-main: #333333;
            --text-muted: #666666;
            --border: #cccccc;
        }

        /* --- RESET & BASE --- */
        * { box-sizing: border-box; user-select: none; outline: none; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: var(--bg-dark); color: var(--text-main); overflow: hidden; }
        
        /* --- LAYOUT GRID --- */
        .app-container {
            display: grid;
            grid-template-areas: 
                "header header header"
                "toolbar canvas panels";
            grid-template-columns: var(--sidebar-width) 1fr var(--panel-width);
            grid-template-rows: var(--header-height) 1fr;
            height: 100vh;
        }

        /* --- HEADER (MENU) --- */
        header {
            grid-area: header;
            background: var(--bg-header);
            display: flex;
            align-items: center;
            padding: 0 10px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }
        .menu-item { padding: 5px 10px; cursor: pointer; border-radius: 3px; }
        .menu-item:hover { background: var(--accent); color: white; }

        /* --- TOOLBAR (LEFT) --- */
        .toolbar {
            grid-area: toolbar;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 10px;
            gap: 5px;
        }
        .tool-btn {
            width: var(--tool-size);
            height: var(--tool-size);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border-radius: 4px;
            color: var(--text-main);
            transition: all 0.2s;
        }
        .tool-btn:hover { background: rgba(255,255,255,0.1); }
        .tool-btn.active { background: var(--accent); color: white; }
        .tool-btn svg { width: 20px; height: 20px; fill: currentColor; }

        /* --- CANVAS AREA (CENTER) --- */
        .canvas-area {
            grid-area: canvas;
            position: relative;
            overflow: auto; /* Allow scrolling if image is big */
            background: #111;
            /* Checkerboard */
            background-image: linear-gradient(45deg, #222 25%, transparent 25%), linear-gradient(-45deg, #222 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #222 75%), linear-gradient(-45deg, transparent 75%, #222 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #canvas-wrapper {
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            background: white; /* Base bg for canvas */
        }

        canvas { display: block; position: absolute; top: 0; left: 0; }

        /* --- PANELS (RIGHT) --- */
        .panels {
            grid-area: panels;
            background: var(--bg-panel);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 10px;
            overflow-y: auto;
        }

        .panel-section { margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .panel-title { font-size: 12px; font-weight: bold; text-transform: uppercase; color: var(--text-muted); margin-bottom: 10px; }

        /* Properties */
        .prop-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; font-size: 13px; }
        input[type="range"] { width: 100px; accent-color: var(--accent); }
        input[type="color"] { border: none; width: 30px; height: 30px; cursor: pointer; padding: 0; background: none; }
        
        /* Layers */
        .layers-list {
            display: flex;
            flex-direction: column-reverse;
            gap: 2px;
            max-height: 200px;
            overflow-y: auto;
        }
        .layer-item {
            display: flex; align-items: center;
            background: var(--bg-dark); padding: 5px;
            border: 1px solid var(--border); cursor: pointer; font-size: 12px;
        }
        .layer-item.active { border-color: var(--accent); background: #2d2d30; }
        .layer-visibility { margin-right: 5px; cursor: pointer; color: var(--text-muted); }
        .layer-visibility.visible { color: var(--text-main); }

        /* UI Components */
        .btn { background: var(--accent); color: white; border: none; padding: 6px 12px; border-radius: 3px; cursor: pointer; font-size: 12px; }
        .btn:hover { background: var(--accent-hover); }
        .btn-secondary { background: transparent; border: 1px solid var(--border); color: var(--text-main); }

        /* Modal & Toast */
        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--bg-header); color: white; padding: 10px 20px; border-radius: 20px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 1000; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal { background: var(--bg-panel); padding: 20px; border-radius: 5px; width: 400px; border: 1px solid var(--border); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 12px; color: var(--text-muted); }
        .form-group input { width: 100%; padding: 8px; background: var(--bg-dark); border: 1px solid var(--border); color: var(--text-main); }

    </style>
</head>
<body class="light-theme">

    <div class="app-container">
        <!-- HEADER -->
        <header>
            <div style="font-weight: bold; margin-right: 20px;">üé® ProPaint 3.0</div>
            <div class="menu-item" onclick="App.handlers.newProject()">Novo</div>
            <div class="menu-item" onclick="App.handlers.triggerImport()">üìÇ Importar Imagem</div>
            <div class="menu-item" onclick="App.handlers.saveProject()">Salvar</div>
            <div class="menu-item" onclick="App.handlers.openProjectModal()">Abrir Projeto</div>
            <div class="menu-item" onclick="App.handlers.exportImage('png')">Exportar PNG</div>
            <div class="menu-item" onclick="App.handlers.toggleTheme()">Tema</div>
        </header>

        <!-- TOOLBAR -->
        <div class="toolbar" id="toolbar">
            <!-- Buttons injected by JS -->
        </div>

        <!-- CANVAS -->
        <div class="canvas-area" id="canvas-container">
            <div id="canvas-wrapper">
                <canvas id="main-canvas"></canvas>
            </div>
        </div>

        <!-- PANELS -->
        <div class="panels">
            <div class="panel-section">
                <div class="panel-title">Ferramenta</div>
                <div class="prop-row">
                    <span>Cor</span>
                    <input type="color" id="color-primary" value="#000000">
                </div>
                <div class="prop-row">
                    <span>Tamanho</span>
                    <input type="range" id="tool-size" min="1" max="50" value="5">
                    <span id="tool-size-val">5px</span>
                </div>
                <div class="prop-row">
                    <span>Opacidade</span>
                    <input type="range" id="tool-opacity" min="1" max="100" value="100">
                </div>
            </div>

            <div class="panel-section">
                <div class="panel-title">Camadas</div>
                <div class="prop-row">
                    <button class="btn btn-secondary" onclick="App.layers.addLayer()">+ Nova</button>
                    <button class="btn btn-secondary" onclick="App.layers.deleteLayer()">üóëÔ∏è</button>
                </div>
                <div class="layers-list" id="layers-list"></div>
            </div>

            <div class="panel-section">
                <div class="panel-title">Hist√≥rico</div>
                <div class="prop-row">
                    <button class="btn btn-secondary" onclick="App.history.undo()">Desfazer (Ctrl+Z)</button>
                    <button class="btn btn-secondary" onclick="App.history.redo()">Refazer (Ctrl+Y)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- HIDDEN INPUT FOR IMPORT -->
    <input type="file" id="import-file" style="display:none" accept="image/*">

    <!-- MODALS -->
    <div id="toast">Notifica√ß√£o</div>
    <div class="modal-overlay" id="modal-new">
        <div class="modal">
            <h3>Novo Projeto</h3>
            <div class="form-group"><label>Largura</label><input type="number" id="new-w" value="800"></div>
            <div class="form-group"><label>Altura</label><input type="number" id="new-h" value="600"></div>
            <button class="btn" onclick="App.handlers.confirmNewProject()">Criar</button>
            <button class="btn btn-secondary" onclick="App.ui.hideModal('modal-new')">Cancelar</button>
        </div>
    </div>
    <div class="modal-overlay" id="modal-open">
        <div class="modal">
            <h3>Projetos Salvos</h3>
            <div id="projects-list"></div>
            <button class="btn btn-secondary" onclick="App.ui.hideModal('modal-open')">Fechar</button>
        </div>
    </div>

    <script>
        /**
         * PROPAINT 3.0 - CORRIGIDO E ROBUSTO
         */

        // 1. HELPERS
        const $ = (sel) => document.querySelector(sel);
        const Toast = {
            show(msg) {
                const el = $('#toast');
                el.innerText = msg;
                el.style.opacity = 1;
                setTimeout(() => el.style.opacity = 0, 2500);
            }
        };

        // 2. ICONS (SVG Strings)
        const Icons = {
            pencil: '<svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>',
            brush: '<svg viewBox="0 0 24 24"><path d="M7 14c-1.66 0-3 1.34-3 3 0 1.31-1.16 2-2 2 .92 1.22 2.49 2 4 2 2.21 0 4-1.79 4-4 0-1.66-1.34-3-3-3zm13.71-9.37l-1.34-1.34c-.39-.39-1.02-.39-1.41 0L9 12.25 11.75 15l8.96-8.96c.39-.39.39-1.02 0-1.41z"/></svg>',
            eraser: '<svg viewBox="0 0 24 24"><path d="M15.14 3c-.51 0-1.02.2-1.41.59L2.59 14.73c-.78.78-.78 2.05 0 2.83L5.17 20c.78.78 2.05.78 2.83 0l11.14-11.14c.79-.78.79-2.05 0-2.83l-2.58-2.58c-.39-.4-1.91-1.45-1.42-.45z"/></svg>',
            fill: '<svg viewBox="0 0 24 24"><path d="M16.56 8.94L7.62 0 6.21 1.41l2.38 2.38-5.15 5.15c-.59.59-.59 1.54 0 2.12l5.5 5.5c.29.29.68.44 1.06.44s.77-.15 1.06-.44l5.5-5.5c.59-.58.59-1.53 0-2.12zM5.21 10L10 5.21 14.79 10H5.21zM19 11.5s-2 2.17-2 3.5c0 1.1.9 2 2 2s2-.9 2-2c0-1.33-2-3.5-2-3.5z"/></svg>',
            line: '<svg viewBox="0 0 24 24"><path d="M3 21L21 3" stroke="currentColor" stroke-width="2"/></svg>',
            rect: '<svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none"/></svg>',
            circle: '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2" fill="none"/></svg>'
        };

        // 3. DATABASE (IndexedDB)
        const DB = {
            db: null,
            init() {
                return new Promise((resolve, reject) => {
                    const req = indexedDB.open('ProPaintDB', 1);
                    req.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('projects')) db.createObjectStore('projects', { keyPath: 'id' });
                    };
                    req.onsuccess = (e) => { this.db = e.target.result; resolve(); };
                    req.onerror = (e) => reject(e);
                });
            },
            async save(project) {
                const tx = this.db.transaction('projects', 'readwrite');
                tx.objectStore('projects').put(project);
            },
            async getAll() {
                return new Promise(resolve => {
                    const tx = this.db.transaction('projects', 'readonly');
                    const req = tx.objectStore('projects').getAll();
                    req.onsuccess = () => resolve(req.result);
                });
            },
            async delete(id) {
                const tx = this.db.transaction('projects', 'readwrite');
                tx.objectStore('projects').delete(id);
            }
        };

        // 4. CORE CLASSES
        class Layer {
            constructor(id, w, h, name) {
                this.id = id;
                this.name = name;
                this.canvas = document.createElement('canvas');
                this.canvas.width = w;
                this.canvas.height = h;
                this.ctx = this.canvas.getContext('2d', { willReadFrequently: true });
                this.visible = true;
            }
        }

        // 5. TOOLS CLASSES
        class Tool {
            constructor(name, icon) { this.name = name; this.icon = icon; }
            onMouseDown(e, layer, settings) {}
            onMouseMove(e, layer, settings) {}
            onMouseUp(layer) {}
        }

        class PencilTool extends Tool {
            constructor() { super('L√°pis', Icons.pencil); }
            onMouseDown(e, layer, s) {
                layer.ctx.beginPath();
                layer.ctx.moveTo(e.x, e.y);
                layer.ctx.lineCap = 'round';
                layer.ctx.strokeStyle = s.color;
                layer.ctx.lineWidth = s.size;
                layer.ctx.globalAlpha = s.opacity;
            }
            onMouseMove(e, layer, s) {
                layer.ctx.lineTo(e.x, e.y);
                layer.ctx.stroke();
            }
            onMouseUp(layer) { layer.ctx.closePath(); layer.ctx.globalAlpha = 1.0; }
        }

        class BrushTool extends Tool {
            constructor() { super('Pincel', Icons.brush); }
            onMouseDown(e, layer, s) {
                layer.ctx.beginPath();
                layer.ctx.moveTo(e.x, e.y);
                layer.ctx.lineCap = 'round';
                layer.ctx.strokeStyle = s.color;
                layer.ctx.lineWidth = s.size;
                layer.ctx.shadowBlur = s.size/2;
                layer.ctx.shadowColor = s.color;
                layer.ctx.globalAlpha = s.opacity;
            }
            onMouseMove(e, layer, s) {
                layer.ctx.lineTo(e.x, e.y);
                layer.ctx.stroke();
            }
            onMouseUp(layer) { 
                layer.ctx.shadowBlur = 0; 
                layer.ctx.globalAlpha = 1.0; 
            }
        }

        class EraserTool extends Tool {
            constructor() { super('Borracha', Icons.eraser); }
            onMouseDown(e, layer, s) {
                layer.ctx.beginPath();
                layer.ctx.moveTo(e.x, e.y);
                layer.ctx.lineCap = 'round';
                layer.ctx.globalCompositeOperation = 'destination-out';
                layer.ctx.lineWidth = s.size;
                layer.ctx.globalAlpha = 1.0;
            }
            onMouseMove(e, layer, s) {
                layer.ctx.lineTo(e.x, e.y);
                layer.ctx.stroke();
            }
            onMouseUp(layer) {
                layer.ctx.globalCompositeOperation = 'source-over';
            }
        }

        class FillTool extends Tool {
            constructor() { super('Balde', Icons.fill); }
            onMouseUp(e, layer, s) {
                const color = this.hexToRgb(s.color);
                const imgData = layer.ctx.getImageData(0,0,layer.canvas.width, layer.canvas.height);
                const data = imgData.data;
                const targetColor = this.getPixel(data, Math.floor(e.x), Math.floor(e.y), layer.canvas.width);
                
                if (this.colorsMatch(targetColor, color)) return;

                const stack = [[Math.floor(e.x), Math.floor(e.y)]];
                while(stack.length) {
                    const [x, y] = stack.pop();
                    const current = this.getPixel(data, x, y, layer.canvas.width);
                    
                    if (x>=0 && x<layer.canvas.width && y>=0 && y<layer.canvas.height && this.colorsMatch(current, targetColor)) {
                        this.setPixel(data, x, y, color);
                        stack.push([x+1, y], [x-1, y], [x, y+1], [x, y-1]);
                    }
                }
                layer.ctx.putImageData(imgData, 0, 0);
            }
            hexToRgb(hex) {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? [parseInt(result[1], 16), parseInt(result[2], 16), parseInt(result[3], 16), 255] : [0,0,0,255];
            }
            getPixel(data, x, y, w) {
                const i = (y * w + x) * 4;
                return [data[i], data[i+1], data[i+2], data[i+3]];
            }
            setPixel(data, x, y, c) {
                const i = (y * w + x) * 4;
                data[i]=c[0]; data[i+1]=c[1]; data[i+2]=c[2]; data[i+3]=c[3];
            }
            colorsMatch(a, b) { return a[0]===b[0] && a[1]===b[1] && a[2]===b[2] && a[3]===b[3]; }
        }

        class RectTool extends Tool {
            constructor() { super('Ret√¢ngulo', Icons.rect); }
            onMouseDown(e, layer, s) { 
                this.start = e; 
                // Snapshot usando tamanho CORRETO da camada
                this.snapshot = layer.ctx.getImageData(0, 0, layer.canvas.width, layer.canvas.height); 
            }
            onMouseMove(e, layer, s) {
                // Restaurar estado inicial
                layer.ctx.putImageData(this.snapshot, 0, 0); 
                // Desenhar novo preview
                layer.ctx.strokeStyle = s.color;
                layer.ctx.lineWidth = s.size;
                layer.ctx.strokeRect(this.start.x, this.start.y, e.x - this.start.x, e.y - this.start.y);
            }
        }

        class CircleTool extends Tool {
            constructor() { super('C√≠rculo', Icons.circle); }
            onMouseDown(e, layer, s) { 
                this.start = e; 
                this.snapshot = layer.ctx.getImageData(0, 0, layer.canvas.width, layer.canvas.height); 
            }
            onMouseMove(e, layer, s) {
                layer.ctx.putImageData(this.snapshot, 0, 0);
                layer.ctx.strokeStyle = s.color;
                layer.ctx.lineWidth = s.size;
                layer.ctx.beginPath();
                const r = Math.sqrt(Math.pow(e.x - this.start.x, 2) + Math.pow(e.y - this.start.y, 2));
                layer.ctx.arc(this.start.x, this.start.y, r, 0, 2 * Math.PI);
                layer.ctx.stroke();
            }
        }

        // 6. APP LOGIC
        const App = {
            state: {
                color: '#000000',
                size: 5,
                opacity: 1.0,
                width: 800,
                height: 600,
            },
            
            tools: {
                list: {},
                current: null,
                isDrawing: false,
            },

            layers: [],
            activeLayerId: null,
            history: { undoStack: [], redoStack: [] },

            async init() {
                console.log("Iniciando ProPaint 3.0...");
                await DB.init();
                
                this.addLayer();
                this.resizeCanvas(800, 600);
                this.setupTools();
                this.setupEvents();
                this.render();
                
                Toast.show("ProPaint pronto!");
            },

            setupTools() {
                const toolbar = $('#toolbar');
                const toolsConfig = [
                    { id: 'pencil', cls: PencilTool },
                    { id: 'brush', cls: BrushTool },
                    { id: 'eraser', cls: EraserTool },
                    { id: 'fill', cls: FillTool },
                    { id: 'rect', cls: RectTool },
                    { id: 'circle', cls: CircleTool }
                ];

                toolsConfig.forEach(({ id, cls }) => {
                    const tool = new cls();
                    this.tools.list[id] = tool;
                    
                    const btn = document.createElement('div');
                    btn.className = 'tool-btn';
                    btn.innerHTML = tool.icon;
                    btn.onclick = () => this.setTool(id);
                    btn.title = tool.name;
                    btn.dataset.id = id;
                    toolbar.appendChild(btn);
                });

                this.setTool('pencil');
            },

            setTool(id) {
                this.state.tool = id;
                this.tools.current = this.tools.list[id];
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                $(`.tool-btn[data-id="${id}"]`).classList.add('active');
            },

            setupEvents() {
                // UI Inputs
                $('#color-primary').oninput = (e) => this.state.color = e.target.value;
                $('#tool-size').oninput = (e) => { this.state.size = parseInt(e.target.value); $('#tool-size-val').innerText = this.state.size + 'px'; };
                $('#tool-opacity').oninput = (e) => this.state.opacity = parseInt(e.target.value) / 100;

                // Import File Listener
                $('#import-file').addEventListener('change', this.handlers.handleImport.bind(this.handlers));

                // Canvas Interactions
                const container = $('#canvas-container');
                
                const getPos = (e) => {
                    const rect = $('#main-canvas').getBoundingClientRect();
                    return {
                        x: e.clientX - rect.left,
                        y: e.clientY - rect.top
                    };
                };

                container.addEventListener('mousedown', (e) => {
                    if(e.button !== 0) return; 
                    const layer = this.getActiveLayer();
                    if(!layer || !layer.visible) return;

                    this.tools.isDrawing = true;
                    // Salvar hist√≥rico ANTES de come√ßar a desenhar
                    this.saveHistory(); 
                    
                    const pos = getPos(e);
                    this.tools.current.onMouseDown(pos, layer, this.state);
                    this.render();
                });

                window.addEventListener('mousemove', (e) => {
                    if(!this.tools.isDrawing) return;
                    const layer = this.getActiveLayer();
                    if(!layer) return;
                    
                    const pos = getPos(e);
                    this.tools.current.onMouseMove(pos, layer, this.state);
                    this.render();
                });

                window.addEventListener('mouseup', () => {
                    if(this.tools.isDrawing) {
                        this.tools.isDrawing = false;
                        const layer = this.getActiveLayer();
                        if(layer) this.tools.current.onMouseUp(layer, this.state);
                    }
                });
                
                // Shortcuts
                window.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 'z') { e.preventDefault(); this.history.undo(); }
                    if (e.ctrlKey && e.key === 'y') { e.preventDefault(); this.history.redo(); }
                });
            },

            // --- MANAGERS ---
            
            getActiveLayer() { return this.layers.find(l => l.id === this.activeLayerId); },
            
            addLayer(name = null) {
                const id = Date.now();
                const l = new Layer(id, this.state.width, this.state.height, name || `Camada ${this.layers.length + 1}`);
                this.layers.push(l);
                this.activeLayerId = id;
                this.renderLayersUI();
            },

            deleteLayer() {
                if(this.layers.length <= 1) {
                    Toast.show("Mantenha pelo menos uma camada.");
                    return;
                }
                this.layers = this.layers.filter(l => l.id !== this.activeLayerId);
                this.activeLayerId = this.layers[this.layers.length-1].id;
                this.renderLayersUI();
                this.render();
            },

            resizeCanvas(w, h) {
                this.state.width = w;
                this.state.height = h;
                $('#main-canvas').width = w;
                $('#main-canvas').height = h;
                $('#canvas-wrapper').style.width = w + 'px';
                $('#canvas-wrapper').style.height = h + 'px';
                
                // Resize existing layers
                this.layers.forEach(l => {
                    // Salvar conte√∫do
                    const temp = l.canvas.toDataURL();
                    l.canvas.width = w;
                    l.canvas.height = h;
                    const img = new Image();
                    img.src = temp;
                    img.onload = () => l.ctx.drawImage(img, 0, 0);
                });
            },

            render() {
                const ctx = $('#main-canvas').getContext('2d');
                ctx.clearRect(0, 0, this.state.width, this.state.height);
                this.layers.forEach(l => {
                    if(l.visible) ctx.drawImage(l.canvas, 0, 0);
                });
            },

            renderLayersUI() {
                const list = $('#layers-list');
                list.innerHTML = '';
                this.layers.slice().reverse().forEach(l => {
                    const el = document.createElement('div');
                    el.className = `layer-item ${l.id === this.activeLayerId ? 'active' : ''}`;
                    el.innerHTML = `
                        <div class="layer-visibility ${l.visible ? 'visible' : ''}" onclick="App.toggleVis(${l.id})">üëÅÔ∏è</div>
                        <span>${l.name}</span>
                    `;
                    el.onclick = (e) => { if(e.target.tagName!=='DIV') { this.activeLayerId = l.id; this.renderLayersUI(); }};
                    list.appendChild(el);
                });
            },

            toggleVis(id) {
                const l = this.layers.find(x => x.id === id);
                l.visible = !l.visible;
                this.renderLayersUI();
                this.render();
            },

            // --- HISTORY ---
            saveHistory() {
                if(this.history.undoStack.length > 10) this.history.undoStack.shift();
                const l = this.getActiveLayer();
                if(l) this.history.undoStack.push({id: l.id, data: l.canvas.toDataURL()});
                this.history.redoStack = []; // Limpar redo ao fazer nova a√ß√£o
            },

            undo() {
                const state = this.history.undoStack.pop();
                if(!state) return;
                
                const l = this.layers.find(x => x.id === state.id);
                if(l) {
                    this.history.redoStack.push({id: l.id, data: l.canvas.toDataURL()});
                    const img = new Image();
                    img.src = state.data;
                    img.onload = () => {
                        l.ctx.clearRect(0,0,l.canvas.width, l.canvas.height);
                        l.ctx.drawImage(img, 0, 0);
                        this.render();
                    };
                }
            },

            redo() {
                const state = this.history.redoStack.pop();
                if(!state) return;
                const l = this.layers.find(x => x.id === state.id);
                if(l) {
                    this.history.undoStack.push({id: l.id, data: l.canvas.toDataURL()});
                    const img = new Image();
                    img.src = state.data;
                    img.onload = () => {
                        l.ctx.clearRect(0,0,l.canvas.width, l.canvas.height);
                        l.ctx.drawImage(img, 0, 0);
                        this.render();
                    };
                }
            },

            // --- HANDLERS ---
            handlers: {
                newProject() { $('#modal-new').style.display = 'flex'; },
                confirmNewProject() {
                    const w = parseInt($('#new-w').value);
                    const h = parseInt($('#new-h').value);
                    if(w && h) {
                        App.resizeCanvas(w, h);
                        App.layers = []; 
                        App.addLayer();
                        App.render();
                        $('#modal-new').style.display = 'none';
                    }
                },
                toggleTheme() { document.body.classList.toggle('light-theme'); },
                
                // IMPORT LOGIC
                triggerImport() {
                    $('#import-file').click();
                },
                
                handleImport(event) {
                    const file = event.target.files[0];
                    if(!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            // Redimensionar canvas para a imagem
                            App.resizeCanvas(img.width, img.height);
                            App.layers = [];
                            App.addLayer("Imagem Importada");
                            
                            const layer = App.getActiveLayer();
                            layer.ctx.drawImage(img, 0, 0);
                            App.render();
                            Toast.show("Imagem carregada!");
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                },

                async saveProject() {
                    const p = {
                        id: Date.now(),
                        name: 'Projeto',
                        w: App.state.width,
                        h: App.state.height,
                        layers: App.layers.map(l => ({id:l.id, data:l.canvas.toDataURL(), name:l.name, visible:l.visible}))
                    };
                    await DB.save(p);
                    Toast.show("Projeto Salvo!");
                },
                async openProjectModal() {
                    const list = $('#projects-list');
                    list.innerHTML = '';
                    const projects = await DB.getAll();
                    if(projects.length === 0) list.innerHTML = "Nenhum projeto salvo.";
                    projects.forEach(p => {
                        const d = document.createElement('div');
                        d.style.padding = "10px 0";
                        d.style.borderBottom = "1px solid var(--border)";
                        d.innerHTML = `<button class="btn" style="width:100%" onclick="App.loadProject(${p.id})">Abrir ${p.name} (${p.w}x${p.h})</button>`;
                        list.appendChild(d);
                    });
                    $('#modal-open').style.display = 'flex';
                },
                exportImage(format) {
                    const link = document.createElement('a');
                    link.download = 'propaint-art.png';
                    link.href = $('#main-canvas').toDataURL();
                    link.click();
                }
            },
            
            async loadProject(id) {
                const projects = await DB.getAll();
                const p = projects.find(x => x.id === id);
                if(p) {
                    App.resizeCanvas(p.w, p.h);
                    App.layers = [];
                    p.layers.forEach(l => {
                        const newL = new Layer(l.id, p.w, p.h, l.name);
                        newL.visible = l.visible;
                        const img = new Image();
                        img.src = l.data;
                        img.onload = () => { newL.ctx.drawImage(img, 0,0); App.render(); };
                        App.layers.push(newL);
                    });
                    App.activeLayerId = App.layers[0].id;
                    App.renderLayersUI();
                    $('#modal-open').style.display = 'none';
                }
            },

            ui: {
                hideModal(id) { $(`#${id}`).style.display = 'none'; }
            }
        };

        // Start
        window.addEventListener('DOMContentLoaded', () => App.init());

    </script>
</body>
</html>
