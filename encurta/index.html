<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkShorty Pro | Encurtador Global</title>
    <meta name="description" content="Encurtador de links funcional em qualquer dispositivo.">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåê</text></svg>">

    <style>
        /* =========================================
           CSS MODERNO E RESPONSIVO
           ========================================= */
        :root {
            --primary: #4f46e5; /* Indigo 600 */
            --primary-hover: #4338ca;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text-main: #111827;
            --text-muted: #6b7280;
            --border: #e5e7eb;
            --success: #10b981;
            --danger: #ef4444;
            --radius: 12px;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Dark Mode */
        body.dark-mode {
            --bg-body: #111827;
            --bg-card: #1f2937;
            --text-main: #f9fafb;
            --text-muted: #9ca3af;
            --border: #374151;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background 0.3s;
        }

        .container { max-width: 800px; margin: 0 auto; padding: 20px; width: 100%; }

        /* Header */
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 0; margin-bottom: 40px;
        }
        .logo { font-size: 1.5rem; font-weight: 800; color: var(--primary); text-decoration: none; display: flex; align-items: center; gap: 8px;}
        
        /* Config Button */
        .btn-icon {
            background: var(--bg-card); border: 1px solid var(--border); color: var(--text-main);
            padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: 0.2s;
        }
        .btn-icon:hover { background: var(--border); }

        /* Main Area */
        .hero { text-align: center; margin-bottom: 50px; }
        .hero h1 { font-size: 2.5rem; margin-bottom: 10px; line-height: 1.2; }
        .hero p { color: var(--text-muted); margin-bottom: 30px; }

        .shortener-box {
            background: var(--bg-card); padding: 15px;
            border-radius: var(--radius); box-shadow: var(--shadow);
            display: flex; flex-direction: column; gap: 10px; border: 1px solid var(--border);
        }
        @media(min-width: 600px) { .shortener-box { flex-direction: row; align-items: stretch; } }

        input {
            flex: 1; padding: 16px; border: 2px solid var(--border); border-radius: 8px;
            background: var(--bg-body); color: var(--text-main); outline: none; transition: 0.2s; font-size: 1rem;
        }
        input:focus { border-color: var(--primary); }

        .btn-action {
            background: var(--primary); color: white; border: none; padding: 0 30px;
            border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-action:hover { background: var(--primary-hover); transform: translateY(-1px); }
        .btn-action:disabled { opacity: 0.6; cursor: wait; transform: none; }

        /* Result Card */
        .result-card {
            display: none; margin-top: 30px; padding: 20px;
            background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border);
            box-shadow: var(--shadow); animation: slideUp 0.3s ease;
        }
        .result-card.active { display: block; }
        .result-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap; }
        .short-link-text {
            color: var(--primary); font-weight: 700; font-size: 1.2rem; word-break: break-all;
        }
        .btn-copy { background: var(--text-main); color: var(--bg-card); padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; }

        /* List */
        .list-title { margin: 40px 0 20px; font-size: 1.2rem; }
        .link-item {
            background: var(--bg-card); padding: 15px; margin-bottom: 10px;
            border-radius: 8px; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;
        }
        .link-details h4 { color: var(--primary); margin-bottom: 4px; cursor: pointer; }
        .link-details p { font-size: 0.85rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 300px; }
        .badge { background: var(--bg-body); padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; color: var(--text-muted); }

        /* Settings Modal */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 100;
        }
        .modal.open { display: flex; }
        .modal-content {
            background: var(--bg-card); padding: 30px; border-radius: var(--radius);
            width: 90%; max-width: 500px; box-shadow: var(--shadow);
        }
        .modal h2 { margin-bottom: 15px; }
        .modal label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        .modal textarea { width: 100%; height: 100px; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-body); color: var(--text-main); font-family: monospace; margin-bottom: 15px; }
        .note { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 15px; line-height: 1.4; }
        .btn-save { width: 100%; background: var(--success); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 700; cursor: pointer; }

        /* Toast */
        .toast {
            position: fixed; bottom: 20px; right: 20px; background: var(--text-main); color: var(--bg-card);
            padding: 12px 24px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: translateY(100px); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 200; display: flex; align-items: center; gap: 10px;
        }
        .toast.show { transform: translateY(0); }
        .toast.error { background: var(--danger); }
        .toast.success { background: var(--success); }

        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        footer { text-align: center; margin-top: auto; padding: 30px; color: var(--text-muted); font-size: 0.8rem; }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <a href="#" class="logo" onclick="window.location.reload()">üåê GlobalLink</a>
            <button class="btn-icon" onclick="toggleSettings()">‚öôÔ∏è Configurar API</button>
        </header>

        <main>
            <section class="hero">
                <h1>Encurtador Links<br><span style="color: var(--primary)">Universal</span></h1>
                <p>Links que funcionam em qualquer lugar, sem servidor pr√≥prio.</p>
                
                <div class="shortener-box">
                    <input type="url" id="urlInput" placeholder="Cole seu link longo aqui (https://...)" required>
                    <button class="btn-action" id="btnShorten" onclick="shortenLink()">Encurtar Agora</button>
                </div>

                <div class="result-card" id="resultCard">
                    <div class="result-row">
                        <span id="shortLinkDisplay" class="short-link-text">...</span>
                        <button class="btn-copy" onclick="copyLink()">Copiar</button>
                    </div>
                    <p style="margin-top: 10px; font-size: 0.9rem; color: var(--success);">
                        ‚úÖ Link criado! Funciona em qualquer dispositivo.
                    </p>
                </div>
            </section>

            <h3 class="list-title">Links Recentes (Nuvem)</h3>
            <div id="linksList">
                <div style="text-align: center; color: var(--text-muted);">Carregando...</div>
            </div>
        </main>

        <footer>
            <p>Powered by JSONBin.io para persist√™ncia na nuvem.</p>
        </footer>
    </div>

    <!-- Modal de Configura√ß√£o -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <h2>‚öôÔ∏è Configura√ß√£o de API</h2>
            <p class="note">
                Para que o link funcione globalmente, precisamos de uma chave de API do <strong>JSONBin.io</strong>.<br><br>
                1. Crie uma conta gratuita em <a href="https://jsonbin.io" target="_blank">jsonbin.io</a>.<br>
                2. Crie um "New Bin" vazio `{}`.<br>
                3. Copie o <strong>X-Master-Key</strong> das configura√ß√µes.<br>
                4. Cole abaixo.
            </p>
            <label>Chave Secreta (X-Master-Key):</label>
            <textarea id="apiKeyInput" placeholder="$2b$10$..."></textarea>
            
            <label>ID do Bin (Opcional - se j√° tiver um criado):</label>
            <input type="text" id="binIdInput" placeholder="Deixe vazio para criar automaticamente" style="width: 100%; margin-bottom: 15px; padding: 10px;">

            <button class="btn-save" onclick="saveSettings()">Salvar Configura√ß√µes</button>
            <button class="btn-icon" style="margin-top: 10px; width: 100%; border: none;" onclick="toggleSettings()">Fechar</button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">Mensagem aqui</div>

    <script>
        /* =========================================
           CONFIGURA√á√ÉO E ESTADO
           ========================================= */
        
        // IMPORTANTE: Como n√£o temos backend real, usaremos um Bin P√∫blico para demonstra√ß√£o.
        // Em produ√ß√£o real, o usu√°rio DEVE inserir sua pr√≥pria chave no modal de configura√ß√µes.
        const DEMO_BIN_ID = '65a5b5a71f5677401f18c7a7'; // ID p√∫blico para demonstra√ß√£o (somente leitura para demonstra√ß√£o)
        // Nota: Para salvar realmente links, usaremos localStorage para persistir a chave do usu√°rio.
        
        const CONFIG_KEY = 'globallink_config';
        let appConfig = JSON.parse(localStorage.getItem(CONFIG_KEY)) || {
            apiKey: '',
            binId: '' 
        };

        /* =========================================
           L√ìGICA PRINCIPAL
           ========================================= */

        document.addEventListener('DOMContentLoaded', () => {
            checkForRedirect();
            loadLinks();
            
            // Preenche inputs do modal se houver config salva
            if(appConfig.apiKey) document.getElementById('apiKeyInput').value = appConfig.apiKey;
            if(appConfig.binId) document.getElementById('binIdInput').value = appConfig.binId;
        });

        // 1. Verifica Redirecionamento
        function checkForRedirect() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('c');

            if (code) {
                showToast('Buscando destino...', 'success');
                findAndRedirect(code);
            }
        }

        async function findAndRedirect(code) {
            try {
                const db = await fetchDatabase();
                const link = db.find(item => item.code === code);

                if (link) {
                    // Incrementar cliques (Opcional, requer write access)
                    if (appConfig.apiKey) {
                        link.clicks = (link.clicks || 0) + 1;
                        // N√£o esperamos o salvamento do click para redirecionar (mais r√°pido)
                        saveDatabase(db); 
                    }
                    
                    setTimeout(() => {
                        window.location.href = link.original;
                    }, 800);
                } else {
                    showToast('Link n√£o encontrado.', 'error');
                    // Remove par√¢metro
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            } catch (error) {
                console.error(error);
                showToast('Erro ao carregar link. Verifique a conex√£o.', 'error');
            }
        }

        // 2. Encurtar Link
        async function shortenLink() {
            const urlInput = document.getElementById('urlInput');
            const original = urlInput.value.trim();
            const btn = document.getElementById('btnShorten');

            if (!isValidUrl(original)) {
                showToast('URL inv√°lida. Comece com http:// ou https://', 'error');
                return;
            }

            if (!appConfig.apiKey) {
                // Abre modal se n√£o tiver chave
                toggleSettings();
                showToast('Configure sua API Key primeiro!', 'error');
                return;
            }

            setLoading(true);

            try {
                let db = await fetchDatabase();
                
                // Gera c√≥digo √∫nico
                let code;
                do {
                    code = Math.random().toString(36).substr(2, 6);
                } while (db.find(item => item.code === code));

                const newLink = {
                    code: code,
                    original: original,
                    clicks: 0,
                    createdAt: new Date().toISOString()
                };

                db.unshift(newLink); // Adiciona no topo
                await saveDatabase(db);

                const shortUrl = `${window.location.origin}${window.location.pathname}?c=${code}`;
                
                // Atualiza UI
                document.getElementById('shortLinkDisplay').textContent = shortUrl;
                document.getElementById('resultCard').classList.add('active');
                urlInput.value = '';
                
                renderList(db);
                showToast('Link encurtado com sucesso!', 'success');

            } catch (error) {
                console.error(error);
                showToast('Erro ao salvar na nuvem. Verifique sua API Key.', 'error');
            } finally {
                setLoading(false);
            }
        }

        // 3. Renderizar Lista
        async function loadLinks() {
            try {
                if (!appConfig.apiKey) {
                    document.getElementById('linksList').innerHTML = `
                        <div style="text-align:center; padding: 20px; border: 1px dashed var(--border); border-radius: 8px;">
                            <p>Para ver e criar links, configure a API.</p>
                            <button class="btn-action" style="margin: 10px auto; padding: 10px 20px;" onclick="toggleSettings()">Configurar Agora</button>
                        </div>`;
                    return;
                }
                const db = await fetchDatabase();
                renderList(db);
            } catch (e) {
                document.getElementById('linksList').innerHTML = `<p style="color:var(--danger)">Erro ao carregar lista.</p>`;
            }
        }

        function renderList(db) {
            const container = document.getElementById('linksList');
            container.innerHTML = '';

            if (db.length === 0) {
                container.innerHTML = '<p style="text-align:center; color: var(--text-muted)">Nenhum link salvo.</p>';
                return;
            }

            db.slice(0, 10).forEach(link => {
                const shortUrl = `${window.location.origin}${window.location.pathname}?c=${link.code}`;
                const el = document.createElement('div');
                el.className = 'link-item';
                el.innerHTML = `
                    <div class="link-details">
                        <h4 onclick="window.open('${shortUrl}', '_blank')">${shortUrl}</h4>
                        <p>${link.original}</p>
                    </div>
                    <div class="badge">üëÅÔ∏è ${link.clicks || 0}</div>
                `;
                container.appendChild(el);
            });
        }

        /* =========================================
           JSONBIN.IO WRAPPER (BACKEND SIMULADO)
           ========================================= */

        async function getHeaders() {
            return {
                'Content-Type': 'application/json',
                'X-Master-Key': appConfig.apiKey
            };
        }

        async function fetchDatabase() {
            // Se n√£o tiver Bin ID, cria um novo ou tenta usar o Demo
            let binId = appConfig.binId;

            if (!binId) {
                // Se for configura√ß√£o nova e n√£o tiver ID, precisamos criar um
                // Mas aqui vamos simplificar: se n√£o tiver ID, tentamos buscar um existente ou falhar
                throw new Error("Bin ID n√£o configurado.");
            }

            const res = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
                headers: await getHeaders()
            });

            if (!res.ok) throw new Error('Falha na API');
            const data = await res.json();
            return data.record;
        }

        async function saveDatabase(data) {
            let binId = appConfig.binId;

            // Se n√£o tiver bin ID, cria um novo
            if (!binId) {
                const res = await fetch(`https://api.jsonbin.io/v3/b`, {
                    method: 'POST',
                    headers: await getHeaders(),
                    body: JSON.stringify(data)
                });
                if (!res.ok) throw new Error('Erro ao criar novo bin');
                const binData = await res.json();
                binId = binData.metadata.id;
                
                // Salva o novo ID na config
                appConfig.binId = binId;
                localStorage.setItem(CONFIG_KEY, JSON.stringify(appConfig));
            } else {
                // Atualiza o existente
                await fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
                    method: 'PUT',
                    headers: await getHeaders(),
                    body: JSON.stringify(data)
                });
            }
        }

        /* =========================================
           UTILIT√ÅRIOS E UI
           ========================================= */

        function isValidUrl(string) {
            try { return Boolean(new URL(string)); }
            catch(e){ return false; }
        }

        function copyLink() {
            const text = document.getElementById('shortLinkDisplay').textContent;
            navigator.clipboard.writeText(text).then(() => showToast('Copiado!', 'success'));
        }

        function toggleSettings() {
            const modal = document.getElementById('settingsModal');
            modal.classList.toggle('open');
        }

        function saveSettings() {
            const key = document.getElementById('apiKeyInput').value.trim();
            const bin = document.getElementById('binIdInput').value.trim();

            if (!key) {
                showToast('A API Key √© obrigat√≥ria.', 'error');
                return;
            }

            appConfig.apiKey = key;
            appConfig.binId = bin;
            localStorage.setItem(CONFIG_KEY, JSON.stringify(appConfig));
            
            toggleSettings();
            showToast('Configura√ß√µes salvas!', 'success');
            loadLinks(); // Recarrega a lista
        }

        function setLoading(isLoading) {
            const btn = document.getElementById('btnShorten');
            if (isLoading) {
                btn.disabled = true;
                btn.innerHTML = 'Processando...';
            } else {
                btn.disabled = false;
                btn.innerHTML = 'Encurtar Agora';
            }
        }

        function showToast(msg, type) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = `toast show ${type}`;
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // Tema Dark autom√°tico
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.classList.add('dark-mode');
        }
    </script>
</body>
</html>
